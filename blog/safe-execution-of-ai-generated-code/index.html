<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Safe execution of AI-generated code :: Dr. Sebastian Castano</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="For this one I wanted to explore two options for secure execution of AI-generated code: E2B, a cloud-based platform using microVMs, and AgentRun, which combines Docker-based execution with safety mechanisms. We will also examine a case study to highlight key differences between the two in terms of setup complexity and execution speed.
Let&rsquo;s get started (unless you want to jump to the conclusions TLDR;).
Runtimes for executing AI-generated code Dedicated runtimes for executing AI-generated code allow agentic systems to execute code without compromising the security of the host. Typical features include memory and CPU constraints, file system isolation, and restricted network access.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://jscastanoc.github.io/blog/safe-execution-of-ai-generated-code/" />





  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/terminal.min.29422bac90082128dbc87421bb91cf7b76f4e417f16aacba8a7fc1d4e8e4e2f1.css">

  
  <link rel="stylesheet" href="https://jscastanoc.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://jscastanoc.github.io/terminal.css">




<link rel="shortcut icon" href="https://jscastanoc.github.io/favicon.png">
<link rel="apple-touch-icon" href="https://jscastanoc.github.io/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Safe execution of AI-generated code">
<meta property="og:description" content="For this one I wanted to explore two options for secure execution of AI-generated code: E2B, a cloud-based platform using microVMs, and AgentRun, which combines Docker-based execution with safety mechanisms. We will also examine a case study to highlight key differences between the two in terms of setup complexity and execution speed.
Let&rsquo;s get started (unless you want to jump to the conclusions TLDR;).
Runtimes for executing AI-generated code Dedicated runtimes for executing AI-generated code allow agentic systems to execute code without compromising the security of the host. Typical features include memory and CPU constraints, file system isolation, and restricted network access.
" />
<meta property="og:url" content="https://jscastanoc.github.io/blog/safe-execution-of-ai-generated-code/" />
<meta property="og:site_name" content="Dr. Sebastian Castano" />

  <meta property="og:image" content="https://jscastanoc.github.io/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-10-29 00:00:00 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="../../">
  <div class="logo">
    Dr. Sebastian Castano
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="../../">1-Home</a></li>
        
      
        
          <li><a href="../../blog">2-Blog</a></li>
        
      
        
          <li><a href="../../pubs">3-Publications</a></li>
        
      
        
          <li><a href="../../about">4-About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="../../" >1-Home</a></li>
        
      
        
          <li><a href="../../blog" >2-Blog</a></li>
        
      
        
          <li><a href="../../pubs" >3-Publications</a></li>
        
      
        
          <li><a href="../../about" >4-About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://jscastanoc.github.io/blog/safe-execution-of-ai-generated-code/">Safe execution of AI-generated code</a>
  </h1>
  <div class="post-meta"><time class="post-date">2024-10-29</time></div>

  
  


  

  <div class="post-content"><div>
        <p>For this one I wanted to explore two options for secure execution of AI-generated code: <a href="https://e2b.dev">E2B</a>, a cloud-based platform using microVMs, and <a href="https://github.com/Jonathan-Adly/AgentRun">AgentRun</a>, which combines Docker-based execution with safety mechanisms. We will also examine a case study to highlight key differences between the two in terms of setup complexity and execution speed.</p>
<p>Let&rsquo;s get started (unless you want to jump to the conclusions <a href="../../blog/safe-execution-of-ai-generated-code/#tldr">TLDR;</a>).</p>
<h2 id="runtimes-for-executing-ai-generated-code">Runtimes for executing AI-generated code<a href="#runtimes-for-executing-ai-generated-code" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Dedicated runtimes for executing AI-generated code allow agentic systems to execute code without compromising the security of the host. Typical features include memory and CPU constraints, file system isolation, and restricted network access.</p>
<h3 id="why-not-just-a-docker-container">Why not just a Docker container?<a href="#why-not-just-a-docker-container" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Docker containers are a common choice for isolating processes, but they have limitations in the context of executing potentially unsafe code. While Docker does provide isolation, it relies on the underlying host OS kernel, making it vulnerable to kernel-level exploits. Properly configuring Docker to execute code securely can also add some setup complexity. Finally, Dockerâ€™s performance can be hindered by overhead associated with container management, making lightweight alternatives more appealing for code execution environments.</p>
<h2 id="the-young-promise-in-the-space-e2b">The young promise in the space: E2B<a href="#the-young-promise-in-the-space-e2b" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>E2B recently raised a <a href="https://www.crunchbase.com/funding_round/e2b-1c91-seed--6b20b90e">$11.5M seed round</a> for its open source platform. Unlike traditional container-based approaches, E2B uses <a href="https://firecracker-microvm.github.io/">Firecracker</a> microVMs, which offer a lightweight and secure execution environment. Their python and javascript SDK is also packed with built-in features for output post-processing and communication with the cloud-instance.</p>
<h3 id="when-to-use-e2b">When to Use E2B<a href="#when-to-use-e2b" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>E2B is ideal for scenarios where security, speed, and scalability are important. The platformâ€™s use of microVMs ensures strong isolation and fast startup times.</p>
<p>In theory, E2B is completely open source, as <a href="https://www.reddit.com/r/LocalLLaMA/comments/1chsx7z/comment/l24qx1t/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button">mentioned by their CEO</a>. But setting it up locally is far from trivial and due to limitations on the architecture of the microVMs, currently it can only be deployed in linux machines ðŸ¥².</p>
<h2 id="alternative-agentrun">Alternative: AgentRun<a href="#alternative-agentrun" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>For those who prefer not to rely on a cloud-based solution, AgentRun offers a viable local execution alternative. Unlike E2B, AgentRun uses Docker containers with extra safety mechanisms, like using <a href="https://restrictedpython.readthedocs.io">RestrictedPython</a> and <a href="https://github.com/Jonathan-Adly/AgentRun/blob/29bf2f6f17186e27d5ab2ebd80bddffc7af8a40d/agentrun/__init__.py#L159">hardcoded constraints</a>.</p>
<h3 id="when-to-use-agentrun">When to Use AgentRun<a href="#when-to-use-agentrun" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>While AgentRun may not offer the same level of advanced features or security guarantees as E2Bâ€™s microVM-based approach, it is well-suited for lightweight local development. It is an appealing choice for quickly testing and iterating on code without relying on cloud infrastructure.</p>
<p>The setup is very simple: build the docker containers and install the python package. We will see the details in the next section. <em>Manos a la obra.</em></p>
<h2 id="case-study">Case Study<a href="#case-study" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>To compare both frameworks, we will use a dataset with the columns: <code>[id, name, age, city, salary]</code> and some dummy entries. We will query the LLM with the question: <em>What is the city with the highest average salary in the provided dataset and what is such salary?</em>. We will use <a href="https://ollama.com">ollama</a> to query <a href="https://ollama.com/library/llama3.2">llama3.2</a>, one of the latest <code>ollama</code> models supporting tool use.</p>
<p><em>Disclaimer</em>: Some code snippets are taken from sample notebooks of <code>E2B</code>, <code>AgentRun</code>, and <code>ollama</code></p>
<h3 id="step-1-install-dependencies-and-import-packages">Step 1: Install dependencies and import packages<a href="#step-1-install-dependencies-and-import-packages" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>uv pip install e2b<span style="color:#f92672">-</span>code<span style="color:#f92672">-</span>interpreter python<span style="color:#f92672">-</span>dotenv ollama docker agentrun
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> docker
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dotenv <span style="color:#f92672">import</span> load_dotenv
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> e2b_code_interpreter <span style="color:#f92672">import</span> Sandbox
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> agentrun <span style="color:#f92672">import</span> AgentRun
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> ollama
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load_dotenv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;E2B_API_KEY&#34;</span>), <span style="color:#e6db74">&#34;E2B_API_KEY is not set in the .env file&#34;</span>
</span></span></code></pre></div><h3 id="step-2-build-and-run-container-agentrun-only">Step 2: Build and run container (AgentRun only)<a href="#step-2-build-and-run-container-agentrun-only" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> contextlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>StringIO()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> contextlib<span style="color:#f92672">.</span>redirect_stdout(f): <span style="color:#75715e"># supress stdout</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">!</span> docker<span style="color:#f92672">-</span>compose <span style="color:#f92672">-</span>f agentrun_docker<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>compose<span style="color:#f92672">.</span>yml up <span style="color:#f92672">-</span>d <span style="color:#f92672">--</span>build 
</span></span><span style="display:flex;"><span>    load_dotenv(<span style="color:#e6db74">&#34;./agentrun_docker/.env.dev&#34;</span>)
</span></span><span style="display:flex;"><span>    CONTAINER_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;CONTAINER_NAME&#34;</span>)
</span></span></code></pre></div><h3 id="step-3-instantiate-runtimes">Step 3: Instantiate runtimes<a href="#step-3-instantiate-runtimes" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sbx_e2b <span style="color:#f92672">=</span> Sandbox()
</span></span><span style="display:flex;"><span>sbx_agentrun <span style="color:#f92672">=</span> AgentRun(container_name<span style="color:#f92672">=</span>CONTAINER_NAME)
</span></span></code></pre></div><h3 id="step-4-copy-dataset-to-runtimes">Step 4: Copy dataset to runtimes<a href="#step-4-copy-dataset-to-runtimes" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>E2B provides a built-in function to do so. For AgentRun, we have to do it manually by copying the dataset to our running container</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;dataset.csv&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># For E2B, we can use the built-in function</span>
</span></span><span style="display:flex;"><span>    sbx_e2b<span style="color:#f92672">.</span>files<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;/code/dataset.csv&#34;</span>, f)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># For AgentRun, we have to do it manually by copying </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the dataset to our running container</span>
</span></span><span style="display:flex;"><span>    client <span style="color:#f92672">=</span> docker<span style="color:#f92672">.</span>from_env()
</span></span><span style="display:flex;"><span>    container <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>containers<span style="color:#f92672">.</span>get(CONTAINER_NAME)
</span></span><span style="display:flex;"><span>    container<span style="color:#f92672">.</span>put_archive(<span style="color:#e6db74">&#34;/code/&#34;</span>, f<span style="color:#f92672">.</span>read())
</span></span></code></pre></div><h3 id="step-5-set-the-users-prompt">Step 5: Set the user&rsquo;s prompt<a href="#step-5-set-the-users-prompt" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We will ask a question about the data. The first part of the prompt could also be part of the system prompt, but we will put it here for simplicity.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>user_message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">You are a data scientist and expert Python programmer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">You will be asked questions about a dataset and will use Python code to analyze the data to answer these questions.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">You have access to a Python environment and can use the run_python_code tool to execute code in this environment.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">The dataset you will work with is provided as a file named &#34;/code/dataset.csv.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Use only pandas.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">What is the city with the highest average salary in the provided dataset and what is such salary?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>messages<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;role&#39;</span>: <span style="color:#e6db74">&#39;user&#39;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;content&#39;</span>: user_message
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h3 id="step-6-query-the-model">Step 6: Query the model<a href="#step-6-query-the-model" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We will use <code>llama3.2</code>, a 8B parameters model with pretty decent scores in tool use given its size. I can run it on my laptop ðŸ™ƒ.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MODEL_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llama3.2&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> ollama<span style="color:#f92672">.</span>chat(
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">=</span>MODEL_NAME,
</span></span><span style="display:flex;"><span>    messages<span style="color:#f92672">=</span>messages,
</span></span><span style="display:flex;"><span>    tools<span style="color:#f92672">=</span>[{
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#39;function&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;function&#39;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;run_python_code&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;Run python code and scripts to answer data science questions&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;parameters&#39;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#39;object&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;properties&#39;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;code&#39;</span>: {
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#39;string&#39;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;The python code to be executed&#39;</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;required&#39;</span>: [<span style="color:#e6db74">&#39;code&#39;</span>],
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  options<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;temperature&#39;</span>: <span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>messages<span style="color:#f92672">.</span>append(response[<span style="color:#e6db74">&#39;message&#39;</span>])
</span></span></code></pre></div><h3 id="step-7-define-the-execution-functions">Step 7: Define the execution functions<a href="#step-7-define-the-execution-functions" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We will define a single function <code>run_ai_generated_code</code> that supports executing the E2B or the AgentRun runtime. Additionally, we will define <code>process_output_e2b</code> and <code>process_output_agentrun</code> since both frameworks handle output data differently.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_output_e2b</span>(execution_output):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> execution_output<span style="color:#f92672">.</span>error:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> execution_output<span style="color:#f92672">.</span>error
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    results_idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> result <span style="color:#f92672">in</span> execution_output<span style="color:#f92672">.</span>results:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result<span style="color:#f92672">.</span>png:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;result-</span><span style="color:#e6db74">{</span>results_idx<span style="color:#e6db74">}</span><span style="color:#e6db74">.png&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                f<span style="color:#f92672">.</span>write(base64<span style="color:#f92672">.</span>b64decode(result<span style="color:#f92672">.</span>png))
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Saved result-</span><span style="color:#e6db74">{</span>results_idx<span style="color:#e6db74">}</span><span style="color:#e6db74">.png&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Result </span><span style="color:#e6db74">{</span>results_idx<span style="color:#e6db74">}</span><span style="color:#e6db74">:&#39;</span>)
</span></span><span style="display:flex;"><span>            print(result)
</span></span><span style="display:flex;"><span>        results_idx <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>  execution_output<span style="color:#f92672">.</span>logs<span style="color:#f92672">.</span>stdout[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_output_agentrun</span>(execution_output):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># AgentRun does not return any fancy output, just the stdout</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> execution_output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_ai_generated_code</span>(
</span></span><span style="display:flex;"><span>                        ai_generated_code: str,
</span></span><span style="display:flex;"><span>                        sbx_runtime: Sandbox <span style="color:#f92672">|</span> AgentRun,
</span></span><span style="display:flex;"><span>                        ):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(sbx_runtime, Sandbox):
</span></span><span style="display:flex;"><span>        runner_function <span style="color:#f92672">=</span> sbx_runtime<span style="color:#f92672">.</span>run_code
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> isinstance(sbx_runtime, AgentRun):
</span></span><span style="display:flex;"><span>        runner_function <span style="color:#f92672">=</span> sbx_runtime<span style="color:#f92672">.</span>execute_code_in_container
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid runtime: </span><span style="color:#e6db74">{</span>sbx_runtime<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    execution <span style="color:#f92672">=</span> runner_function(ai_generated_code)
</span></span><span style="display:flex;"><span>    process_output_function <span style="color:#f92672">=</span> process_output_e2b <span style="color:#66d9ef">if</span> isinstance(sbx_runtime, Sandbox) <span style="color:#66d9ef">else</span> process_output_agentrun
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> process_output_function(execution)
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><h3 id="step-8-process-the-llms-response">Step 8: Process the LLM&rsquo;s response<a href="#step-8-process-the-llms-response" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Execute code in the E2B and AgentRun runtimes, according to the tool usage defined by the model output</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>messages_e2b <span style="color:#f92672">=</span> messages<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>messages_agentrun <span style="color:#f92672">=</span> messages<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># make sure the LLM decided to use the tools correctly</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> response[<span style="color:#e6db74">&#39;message&#39;</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;tool_calls&#39;</span>):
</span></span><span style="display:flex;"><span>    available_functions <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;run_python_code&#39;</span>: run_ai_generated_code,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># loop through each tool use</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tool <span style="color:#f92672">in</span> response[<span style="color:#e6db74">&#39;message&#39;</span>][<span style="color:#e6db74">&#39;tool_calls&#39;</span>]:
</span></span><span style="display:flex;"><span>        arguments <span style="color:#f92672">=</span> tool[<span style="color:#e6db74">&#39;function&#39;</span>][<span style="color:#e6db74">&#39;arguments&#39;</span>]
</span></span><span style="display:flex;"><span>        code <span style="color:#f92672">=</span> arguments[<span style="color:#e6db74">&#39;code&#39;</span>]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;Generated code:&#39;</span>)
</span></span><span style="display:flex;"><span>        print(code)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># Execute generated code on e2b and agentrun</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> runtime_name <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;e2b&#34;</span>,<span style="color:#e6db74">&#34;agentrun&#34;</span>]:
</span></span><span style="display:flex;"><span>            start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([<span style="color:#e6db74">&#39;=&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Executing code in the </span><span style="color:#e6db74">{</span>runtime_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> sandbox....&#39;</span>)
</span></span><span style="display:flex;"><span>            runtime <span style="color:#f92672">=</span> sbx_e2b <span style="color:#66d9ef">if</span> runtime_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;e2b&#34;</span> <span style="color:#66d9ef">else</span> sbx_agentrun
</span></span><span style="display:flex;"><span>            function_to_call <span style="color:#f92672">=</span> available_functions[tool[<span style="color:#e6db74">&#39;function&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]]
</span></span><span style="display:flex;"><span>            function_response <span style="color:#f92672">=</span> function_to_call(code, runtime)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Code execution finished!&#39;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Response from the function:&#39;</span>)
</span></span><span style="display:flex;"><span>            print(function_response)
</span></span><span style="display:flex;"><span>            end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Elapsed time: </span><span style="color:#e6db74">{</span>end_time <span style="color:#f92672">-</span> start_time<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> seconds&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> runtime_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;e2b&#34;</span>:       
</span></span><span style="display:flex;"><span>                messages_e2b<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;role&#39;</span>: <span style="color:#e6db74">&#39;tool&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;content&#39;</span>: function_response
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> runtime_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;agentrun&#34;</span>:
</span></span><span style="display:flex;"><span>                messages_agentrun<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;role&#39;</span>: <span style="color:#e6db74">&#39;tool&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;content&#39;</span>: function_response
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid runtime name: </span><span style="color:#e6db74">{</span>runtime_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h3 id="the-output">The output:<a href="#the-output" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<pre tabindex="0"><code>    Generated code:
    import pandas as pd
    import numpy as np
    # Load the dataset
    df = pd.read_csv(&#34;/code/dataset.csv&#34;)
    # Group by city and calculate average salary
    avg_salary_by_city = df.groupby(&#34;city&#34;)[&#39;salary&#39;].mean()
    # Get the city with the highest average salary and its value
    highest_avg_salary_city = avg_salary_by_city.idxmax()
    highest_avg_salary = avg_salary_by_city.max()
    print(f&#34;The city with the highest average salary is {highest_avg_salary_city} with an average salary of {highest_avg_salary}&#34;)
    =====================================================================================
    Executing code in the e2b sandbox....
    Code execution finished!
    Response from the function:
    The city with the highest average salary is Seattle with an average salary of 73500.0
    
    Elapsed time: 0.34 seconds
    =====================================================================================
    Executing code in the agentrun sandbox....
    Code execution finished!
    Response from the function:
    The city with the highest average salary is Seattle with an average salary of 73500.0
    
    Elapsed time: 1.90 seconds
</code></pre><p>I was expecting a difference in the execution times, but it is impressive that E2B manages to be x5.2 faster (on average, N=10) than using a local container on a decent laptop.</p>
<h2 id="tldr">TLDR;<a href="#tldr" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p><a href="https://e2b.dev/">E2B</a> is a solid option for blazing fast and secure code execution in the cloud. While straightforward support for local development is not there yet , it comes packed with many built-in features, and comprehensive documentation.</p>
<p><a href="https://github.com/Jonathan-Adly/AgentRun">AgentRun</a> is lightweight and super easy to setup.  It lacks some advanced features found in E2B, it is an ideal choice for developers who prefer a simpler, self-hosted solution.</p>
<p>You can find the code for a side-to-side comparison here: <a href="https://github.com/jscastanoc/ai-code-runtime">https://github.com/jscastanoc/ai-code-runtime</a></p>
<h2 id="sources">Sources<a href="#sources" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<ul>
<li><a href="https://e2b.dev/">https://e2b.dev/</a></li>
<li><a href="https://github.com/Jonathan-Adly/AgentRun">https://github.com/Jonathan-Adly/AgentRun</a></li>
<li><a href="https://www.youtube.com/watch?v=XmExYTHmvbw">Video: E2B: The Missing Piece for AI Agents?</a></li>
<li><a href="https://www.reddit.com/r/LocalLLaMA/comments/1chsx7z/is_there_an_opensource_alternative_to_e2b_e2bdev/">Reddit: is there an open source alternative to e2b?</a></li>
</ul>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2024 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="../../bundle.min.js"></script>





  
</div>

</body>
</html>
